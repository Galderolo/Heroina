<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hero√≠na del Hogar - Misiones</title>
    
    <!-- Bootstrap 5.3 CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    
    <!-- Bootstrap Icons -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css">
    
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=MedievalSharp&family=Quicksand:wght@400;600;700&display=swap" rel="stylesheet">
    
    <!-- Estilos personalizados -->
    <link rel="stylesheet" href="css/styles.css">
</head>
<body>
    <!-- Navbar -->
    <nav class="navbar navbar-expand-lg navbar-dark bg-adventure">
        <div class="container-fluid">
            <a class="navbar-brand fantasy-font" href="index.html">
                <i class="bi bi-shield-fill"></i> Hero√≠na del Hogar
            </a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav ms-auto">
                    <li class="nav-item">
                        <a class="nav-link" href="index.html">
                            <i class="bi bi-person-circle"></i> Mi Personaje
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link active" href="misiones.html">
                            <i class="bi bi-list-check"></i> Misiones
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="tienda.html">
                            <i class="bi bi-shop"></i> Tienda
                        </a>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <!-- Contenido Principal -->
    <div class="container my-4">
        <!-- Header con Recursos -->
        <div class="card recursos-header shadow-sm mb-4">
            <div class="card-body">
                <div class="row align-items-center">
                    <div class="col-md-4">
                        <h4 class="fantasy-font mb-0">
                            <i class="bi bi-list-check"></i> Mis Misiones
                        </h4>
                    </div>
                    <div class="col-md-8">
                        <div class="row text-center">
                            <div class="col-3 col-md-2">
                                <small>Nivel</small>
                                <h5 class="mb-0" id="headerNivel">1</h5>
                            </div>
                            <div class="col-3 col-md-3">
                                <small>Energ√≠a</small>
                                <h5 class="mb-0 text-primary" id="headerEnergia">6</h5>
                            </div>
                            <div class="col-3 col-md-2">
                                <small>Vidas</small>
                                <h5 class="mb-0 text-danger" id="headerVidas">‚ù§Ô∏è‚ù§Ô∏è‚ù§Ô∏è</h5>
                            </div>
                            <div class="col-3 col-md-2">
                                <small>Oro</small>
                                <h5 class="mb-0 text-warning" id="headerOro">0</h5>
                            </div>
                            <div class="col-12 col-md-3 mt-2 mt-md-0">
                                <small>Misiones Hoy</small>
                                <h5 class="mb-0 text-success" id="headerMisionesHoy">0</h5>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Filtros -->
        <div class="mb-4">
            <div class="btn-group w-100" role="group">
                <button type="button" class="btn btn-outline-primary active" onclick="filtrarMisiones('todas')">
                    Todas
                </button>
                <button type="button" class="btn btn-outline-success" onclick="filtrarMisiones('diaria')">
                    Diarias
                </button>
                <button type="button" class="btn btn-outline-info" onclick="filtrarMisiones('ayuda')">
                    Ayuda
                </button>
                <button type="button" class="btn btn-outline-warning" onclick="filtrarMisiones('epica')">
                    √âpicas
                </button>
            </div>
        </div>

        <!-- Lista de Misiones Diarias -->
        <div id="misionesDiarias" class="misiones-seccion">
            <h5 class="section-title">
                <i class="bi bi-sunrise"></i> Misiones Diarias
            </h5>
            <div id="listaDiarias" class="row">
                <!-- Se llenar√° con JavaScript -->
            </div>
        </div>

        <!-- Lista de Misiones de Ayuda -->
        <div id="misionesAyuda" class="misiones-seccion">
            <h5 class="section-title">
                <i class="bi bi-heart-fill"></i> Misiones de Ayuda
            </h5>
            <div id="listaAyuda" class="row">
                <!-- Se llenar√° con JavaScript -->
            </div>
        </div>

        <!-- Lista de Misiones √âpicas -->
        <div id="misionesEpicas" class="misiones-seccion">
            <h5 class="section-title">
                <i class="bi bi-trophy-fill"></i> Misiones √âpicas
            </h5>
            <div id="listaEpicas" class="row">
                <!-- Se llenar√° con JavaScript -->
            </div>
        </div>
    </div>

    <!-- Modal de Confirmaci√≥n -->
    <div class="modal fade" id="modalConfirmacion" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header bg-success text-white">
                    <h5 class="modal-title"><i class="bi bi-check-circle"></i> Completar Misi√≥n</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body text-center">
                    <h5 class="mb-3" id="modalMisionNombre"></h5>
                    <p class="fs-6">¬øEsta misi√≥n ha sido completada?</p>
                    <div class="alert alert-info">
                        <small><i class="bi bi-info-circle"></i> Solo marca como completada si realmente se hizo la tarea</small>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                        <i class="bi bi-x-lg"></i> No, Cancelar
                    </button>
                    <button type="button" class="btn btn-success" onclick="confirmarMision()">
                        <i class="bi bi-check-lg"></i> S√≠, Completar
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal de Recompensa -->
    <div class="modal fade" id="modalRecompensa" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-body text-center p-4">
                    <div class="mb-3">
                        <span class="mision-icono-grande" id="modalRecompensaIcono">‚ú®</span>
                    </div>
                    <h3 class="fantasy-font mb-3">¬°Misi√≥n Completada!</h3>
                    <h5 id="modalRecompensaMision" class="mb-4"></h5>
                    
                    <div class="row">
                        <div class="col-6">
                            <div class="recompensa-box">
                                <i class="bi bi-star-fill fs-1 text-info"></i>
                                <p class="mb-0 mt-2">XP Ganada</p>
                                <h3 class="text-info" id="modalRecompensaXP">0</h3>
                            </div>
                        </div>
                        <div class="col-6">
                            <div class="recompensa-box">
                                <i class="bi bi-coin fs-1 text-warning"></i>
                                <p class="mb-0 mt-2">Oro Ganado</p>
                                <h3 class="text-warning" id="modalRecompensaOro">0</h3>
                            </div>
                        </div>
                    </div>
                    
                    <button type="button" class="btn btn-primary btn-lg mt-4" data-bs-dismiss="modal">
                        ¬°Genial!
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal de Subida de Nivel -->
    <div class="modal fade" id="modalSubidaNivel" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-body text-center p-4">
                    <i class="bi bi-trophy-fill fs-1 text-warning"></i>
                    <h2 class="fantasy-font mt-3">¬°Subiste de Nivel!</h2>
                    <p class="fs-4">Ahora eres nivel <span id="modalNuevoNivel"></span></p>
                    <div class="alert alert-success">
                        <h5>Nuevo T√≠tulo Desbloqueado:</h5>
                        <p class="fs-5 fw-bold mb-0" id="modalNuevoTitulo"></p>
                    </div>
                    <button type="button" class="btn btn-primary btn-lg" data-bs-dismiss="modal">
                        ¬°Genial!
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    
    <!-- Canvas Confetti -->
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    
    <!-- Scripts del juego -->
    <script src="js/data.js"></script>
    <script src="js/storage.js"></script>
    <script src="js/game.js"></script>
    
    <!-- Script de la p√°gina -->
    <script>
        let misionSeleccionada = null;
        
        function actualizarHeader() {
            const summary = window.game.getCharacterSummary();
            const state = window.game.getState();
            const energy = state.character.energy || 0;
            const maxEnergy = state.character.maxEnergy || 6;
            const lives = state.character.lives !== undefined ? state.character.lives : 3;
            
            document.getElementById('headerNivel').textContent = summary.level;
            document.getElementById('headerEnergia').innerHTML = `${energy}/${maxEnergy} ‚ö°`;
            
            let livesHTML = '';
            for (let i = 0; i < lives; i++) {
                livesHTML += '‚ù§Ô∏è';
            }
            if (lives === 0) {
                livesHTML = 'üíî';
            }
            document.getElementById('headerVidas').innerHTML = livesHTML || 'üíî';
            
            document.getElementById('headerOro').textContent = summary.gold;
            document.getElementById('headerMisionesHoy').textContent = summary.todayStats.missions;
        }
        
        function crearTarjetaMision(mission) {
            const colorClass = {
                'diaria': 'border-success',
                'ayuda': 'border-info',
                'epica': 'border-warning'
            };
            
            const state = window.game.getState();
            const currentEnergy = state.character.energy || 0;
            const activeMission = window.game.getActiveMission();
            const isActive = activeMission && activeMission.missionId === mission.id;
            const hasOtherActive = activeMission && activeMission.missionId !== mission.id;
            const noEnergy = currentEnergy < 2 && !isActive;
            
            let buttonHTML = '';
            let cardClass = '';
            
            if (isActive) {
                cardClass = 'mision-en-progreso';
                buttonHTML = `
                    <button class="btn btn-success w-100 mb-2" onclick="completarMisionDirecta(${mission.id})">
                        <i class="bi bi-check-circle-fill"></i> ¬°Completada!
                    </button>
                    <div class="row">
                        <div class="col-6">
                            <button class="btn btn-danger w-100 btn-sm" onclick="fracasarMision()">
                                <i class="bi bi-x-circle-fill"></i> Fracas√≥ (-1 ‚ù§Ô∏è)
                            </button>
                        </div>
                        <div class="col-6">
                            <button class="btn btn-outline-secondary w-100 btn-sm" onclick="cancelarMision()">
                                <i class="bi bi-arrow-counterclockwise"></i> Cancelar
                            </button>
                        </div>
                    </div>
                `;
            } else if (hasOtherActive) {
                cardClass = 'mision-deshabilitada';
                buttonHTML = `
                    <button class="btn btn-secondary w-100" disabled>
                        <i class="bi bi-lock"></i> Otra misi√≥n en curso
                    </button>
                `;
            } else if (noEnergy) {
                cardClass = 'mision-deshabilitada';
                buttonHTML = `
                    <button class="btn btn-secondary w-100" disabled>
                        <i class="bi bi-lightning-charge"></i> Sin energ√≠a (necesitas 2 ‚ö°)
                    </button>
                `;
            } else {
                buttonHTML = `
                    <button class="btn btn-primary w-100" onclick="iniciarMision(${mission.id})">
                        <i class="bi bi-play-fill"></i> Iniciar Misi√≥n (-2 ‚ö°)
                    </button>
                `;
            }
            
            return `
                <div class="col-md-6 col-lg-4 mb-3 mision-item" data-tipo="${mission.type}">
                    <div class="card h-100 mision-card ${colorClass[mission.type]} ${cardClass}">
                        <div class="card-body">
                            ${isActive ? '<div class="badge bg-warning text-dark mb-2"><i class="bi bi-hourglass-split"></i> En Progreso</div>' : ''}
                            <div class="mision-icono mb-2">${mission.icon}</div>
                            <h6 class="card-title fw-bold">${mission.name}</h6>
                            <p class="card-text small text-muted">${mission.description}</p>
                            
                            <div class="mision-recompensas mb-3">
                                <span class="badge bg-primary me-2">
                                    <i class="bi bi-lightning-charge-fill"></i> 2 Energ√≠a
                                </span>
                                <span class="badge bg-info me-2">
                                    <i class="bi bi-star-fill"></i> ${mission.xp} XP
                                </span>
                                <span class="badge bg-warning">
                                    <i class="bi bi-coin"></i> ${mission.gold} Oro
                                </span>
                            </div>
                            
                            ${buttonHTML}
                        </div>
                    </div>
                </div>
            `;
        }
        
        function cargarMisiones() {
            const daily = MISSIONS.filter(m => m.type === 'diaria');
            const help = MISSIONS.filter(m => m.type === 'ayuda');
            const epic = MISSIONS.filter(m => m.type === 'epica');
            
            document.getElementById('listaDiarias').innerHTML = daily.map(crearTarjetaMision).join('');
            document.getElementById('listaAyuda').innerHTML = help.map(crearTarjetaMision).join('');
            document.getElementById('listaEpicas').innerHTML = epic.map(crearTarjetaMision).join('');
        }
        
        function filtrarMisiones(tipo) {
            const sections = document.querySelectorAll('.misiones-seccion');
            const buttons = document.querySelectorAll('.btn-group .btn');
            
            buttons.forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');
            
            if (tipo === 'todas') {
                sections.forEach(s => s.style.display = 'block');
            } else {
                sections.forEach(s => s.style.display = 'none');
                if (tipo === 'diaria') {
                    document.getElementById('misionesDiarias').style.display = 'block';
                } else if (tipo === 'ayuda') {
                    document.getElementById('misionesAyuda').style.display = 'block';
                } else if (tipo === 'epica') {
                    document.getElementById('misionesEpicas').style.display = 'block';
                }
            }
        }
        
        function iniciarMision(missionId) {
            const result = window.game.startMission(missionId);
            
            if (!result.success) {
                alert(result.message);
                return;
            }
            
            cargarMisiones();
            actualizarHeader();
        }
        
        function cancelarMision() {
            if (confirm('¬øCancelar la misi√≥n?\n\nNo pierdes nada, pero tampoco ganas.')) {
                window.game.cancelActiveMission();
                cargarMisiones();
                actualizarHeader();
            }
        }
        
        function fracasarMision() {
            if (!confirm('‚ö†Ô∏è ¬øSeguro que la misi√≥n FRACAS√ì?\n\nSe perder√° 1 vida ‚ù§Ô∏è y 2 de energ√≠a ‚ö°')) {
                return;
            }
            
            const result = window.game.failActiveMission();
            
            if (!result.success) {
                alert(result.message);
                return;
            }
            
            if (result.noLives) {
                alert(`üíî ¬°Misi√≥n fracasada!\n\n‚ù§Ô∏è Has perdido una vida.\n\n‚ö†Ô∏è ¬°NO QUEDAN VIDAS! Ten m√°s cuidado.`);
            } else {
                alert(`üíî ¬°Misi√≥n fracasada!\n\n‚ù§Ô∏è Has perdido una vida.\nVidas restantes: ${result.remainingLives}`);
            }
            
            setTimeout(() => {
                cargarMisiones();
                actualizarHeader();
            }, 500);
        }
        
        function completarMisionDirecta(missionId) {
            const mission = MISSIONS.find(m => m.id === missionId);
            misionSeleccionada = mission;
            
            document.getElementById('modalMisionNombre').textContent = mission.name;
            
            const modal = new bootstrap.Modal(document.getElementById('modalConfirmacion'));
            modal.show();
        }
        
        function confirmarMision() {
            if (!misionSeleccionada) return;
            
            const result = window.game.completeActiveMission();
            
            if (!result.success) {
                alert(result.message);
                return;
            }
            
            const modalConfirmacion = bootstrap.Modal.getInstance(document.getElementById('modalConfirmacion'));
            modalConfirmacion.hide();
            
            setTimeout(() => {
                mostrarRecompensa(result);
                
                if (result.leveledUp) {
                    setTimeout(() => {
                        mostrarSubidaNivel(result);
                    }, 2000);
                }
            }, 300);
            
            setTimeout(() => {
                cargarMisiones();
                actualizarHeader();
            }, 500);
            
            misionSeleccionada = null;
        }
        
        function mostrarRecompensa(result) {
            document.getElementById('modalRecompensaIcono').textContent = result.mission.icon;
            document.getElementById('modalRecompensaMision').textContent = result.mission.name;
            document.getElementById('modalRecompensaXP').textContent = '+' + result.xpGained;
            document.getElementById('modalRecompensaOro').textContent = '+' + result.goldGained;
            
            const modal = new bootstrap.Modal(document.getElementById('modalRecompensa'));
            modal.show();
            
            confetti({
                particleCount: 100,
                spread: 70,
                origin: { y: 0.6 }
            });
        }
        
        function mostrarSubidaNivel(result) {
            document.getElementById('modalNuevoNivel').textContent = result.newLevel;
            document.getElementById('modalNuevoTitulo').textContent = result.title;
            
            const modal = new bootstrap.Modal(document.getElementById('modalSubidaNivel'));
            modal.show();
            
            confetti({
                particleCount: 200,
                spread: 100,
                origin: { y: 0.6 },
                colors: ['#FFD700', '#FFA500', '#FF8C00']
            });
        }
        
        document.addEventListener('DOMContentLoaded', () => {
            cargarMisiones();
            actualizarHeader();
        });
    </script>
</body>
</html>
