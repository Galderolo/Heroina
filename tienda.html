<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Heroes del Hogar - Tienda de Recompensas</title>
    
    <!-- Bootstrap 5.3 CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    
    <!-- Bootstrap Icons -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css">
    
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=MedievalSharp&family=Quicksand:wght@400;600;700&display=swap" rel="stylesheet">
    
    <!-- Estilos personalizados -->
    <link rel="stylesheet" href="css/styles.css">
    
    <!-- PWA Manifest -->
    <link rel="manifest" href="./manifest.json">
    <meta name="theme-color" content="#0f3460">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Heroes del Hogar">
    <link rel="apple-touch-icon" href="./img/icon-192.svg">
</head>
<body>
    <!-- Navbar -->
    <nav class="navbar navbar-expand-lg navbar-dark bg-adventure fixed-top">
        <div class="container-fluid">
            <a class="navbar-brand fantasy-font" href="index.html">
                <i class="bi bi-shield-fill"></i> Heroes del Hogar
            </a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav ms-auto">
                    <li class="nav-item" id="installPWA" style="display: none;">
                        <a class="nav-link" href="#" id="installButton">
                            <i class="bi bi-download"></i> Instalar
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="index.html">
                            <i class="bi bi-person-circle"></i> Mi Personaje
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="misiones.html">
                            <i class="bi bi-list-check"></i> Misiones
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link active" href="tienda.html">
                            <i class="bi bi-shop"></i> Tienda
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="custom.html">
                            <i class="bi bi-gear"></i> Personalizar
                        </a>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <!-- Contenido Principal -->
    <div class="container my-4">
        <!-- Header con Recursos -->
        <div class="card recursos-header shadow-sm mb-4">
            <div class="card-body">
                <div class="row align-items-center">
                    <div class="col-md-4">
                        <h4 class="fantasy-font mb-0">
                            <i class="bi bi-shop"></i> Tienda de Recompensas
                        </h4>
                    </div>
                    <div class="col-md-8">
                        <div class="stats-compact">
                            <span class="stat-item">
                                <small>Nivel</small> <strong id="headerNivel">1</strong>
                            </span>
                            <span class="stat-separator">|</span>
                            <span class="stat-item">
                                <small>Oro</small> <strong class="text-warning" id="headerOro">0 <i class="bi bi-coin text-warning"></i></strong>
                            </span>
                            <span class="stat-separator">|</span>
                            <span class="stat-item">
                                <small>Compradas</small> <strong class="text-success" id="headerCompradas">0</strong>
                            </span>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Filtros -->
        <div class="mb-4">
            <div class="btn-group w-100 shop-filters-group" role="group">
                <button type="button" class="btn btn-outline-primary active shop-filter-btn" onclick="filtrarRecompensas('todas')">
                    Todas
                </button>
                <button type="button" class="btn btn-outline-purple shop-filter-btn" onclick="filtrarRecompensas('potion')">
                    Pociones
                </button>
                <button type="button" class="btn btn-outline-success shop-filter-btn" onclick="filtrarRecompensas('peque√±a')">
                    Peque√±as
                </button>
                <button type="button" class="btn btn-outline-info shop-filter-btn" onclick="filtrarRecompensas('media')">
                    Medias
                </button>
                <button type="button" class="btn btn-outline-warning shop-filter-btn" onclick="filtrarRecompensas('grande')">
                    Grandes
                </button>
                <button type="button" class="btn btn-outline-danger shop-filter-btn" onclick="filtrarRecompensas('epica')">
                    √âpicas
                </button>
            </div>
        </div>

        <!-- Lista de Pociones -->
        <div id="recompensasPociones" class="recompensas-seccion">
            <h5 class="section-title">
                <i class="bi bi-droplet-fill"></i> Pociones M√°gicas
            </h5>
            <div id="listaPociones" class="row">
            </div>
        </div>

        <!-- Lista de Recompensas Peque√±as -->
        <div id="recompensasPequenas" class="recompensas-seccion">
            <h5 class="section-title">
                <i class="bi bi-gift"></i> Recompensas Peque√±as
            </h5>
            <div id="listaPequenas" class="row">
                <!-- Se llenar√° con JavaScript -->
            </div>
        </div>

        <!-- Lista de Recompensas Medias -->
        <div id="recompensasMedias" class="recompensas-seccion">
            <h5 class="section-title">
                <i class="bi bi-gift-fill"></i> Recompensas Medias
            </h5>
            <div id="listaMedias" class="row">
                <!-- Se llenar√° con JavaScript -->
            </div>
        </div>

        <!-- Lista de Recompensas Grandes -->
        <div id="recompensasGrandes" class="recompensas-seccion">
            <h5 class="section-title">
                <i class="bi bi-star-fill"></i> Recompensas Grandes
            </h5>
            <div id="listaGrandes" class="row">
                <!-- Se llenar√° con JavaScript -->
            </div>
        </div>

        <!-- Lista de Recompensas √âpicas -->
        <div id="recompensasEpicas" class="recompensas-seccion">
            <h5 class="section-title">
                <i class="bi bi-trophy-fill"></i> Recompensas √âpicas
            </h5>
            <div id="listaEpicas" class="row">
                <!-- Se llenar√° con JavaScript -->
            </div>
        </div>
    </div>

    <!-- Modal de Confirmaci√≥n de Compra -->
    <div class="modal fade" id="modalConfirmacion" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Confirmar Compra</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="text-center mb-3">
                        <span class="recompensa-icono-grande" id="modalRecompensaIcono">üéÅ</span>
                    </div>
                    <h5 id="modalRecompensaNombre" class="text-center mb-3"></h5>
                    <p id="modalRecompensaDescripcion" class="text-center text-muted"></p>
                    <div class="alert alert-warning text-center">
                        <h4>
                            <i class="bi bi-coin"></i> <span id="modalRecompensaPrecio"></span> Oro
                        </h4>
                    </div>
                    <p class="text-center">¬øQuieres canjear esta recompensa?</p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="button" class="btn btn-warning" onclick="confirmarCompra()">
                        <i class="bi bi-bag-check"></i> Comprar
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal de Compra Exitosa -->
    <div class="modal fade" id="modalExito" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-body text-center p-4">
                    <i class="bi bi-check-circle-fill fs-1 text-success"></i>
                    <h2 class="fantasy-font mt-3">¬°Compra Exitosa!</h2>
                    <div class="mb-3">
                        <span class="recompensa-icono-grande" id="modalExitoIcono">üéÅ</span>
                    </div>
                    <h5 id="modalExitoNombre" class="mb-3"></h5>
                    <div class="alert alert-info">
                        <p class="mb-0">¬°Ahora puedes disfrutar de tu recompensa!</p>
                    </div>
                    <p class="text-muted">
                        Oro restante: <span class="fw-bold text-warning" id="modalExitoOroRestante"></span>
                    </p>
                    <button type="button" class="btn btn-primary btn-lg" data-bs-dismiss="modal">
                        ¬°Genial!
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modales Personalizados -->
    <!-- Modal de Alerta -->
    <div id="customAlert" class="custom-modal">
        <div class="custom-modal-content">
            <div class="custom-modal-icon" id="alertIcon">‚ÑπÔ∏è</div>
            <h3 id="alertTitle" style="color: #ffd700;">Aviso</h3>
            <p id="alertMessage" style="color: #e0e0e0; font-size: 1.1rem;"></p>
            <button class="custom-modal-btn" onclick="closeAlert()">Aceptar</button>
        </div>
    </div>

    <!-- Modal de Confirmaci√≥n -->
    <div id="customConfirm" class="custom-modal">
        <div class="custom-modal-content">
            <div class="custom-modal-icon">‚ö†Ô∏è</div>
            <h3 id="confirmTitle" style="color: #ffd700;">Confirmar</h3>
            <p id="confirmMessage" style="color: #e0e0e0; font-size: 1.1rem;"></p>
            <div class="custom-modal-buttons">
                <button class="custom-modal-btn btn-confirm" id="confirmYes">S√≠</button>
                <button class="custom-modal-btn btn-cancel" id="confirmNo">No</button>
            </div>
        </div>
    </div>

    <!-- Modal de Recompensa -->
    <div id="customReward" class="custom-modal">
        <div class="custom-modal-content reward-modal">
            <div class="reward-animation">üéâ</div>
            <h2 id="rewardTitle" style="color: #ffd700; font-size: 2rem;">¬°Misi√≥n Completada!</h2>
            <div class="reward-details" id="rewardDetails" style="color: #e0e0e0; font-size: 1.3rem; margin: 1.5rem 0;"></div>
            <button class="custom-modal-btn btn-success" onclick="closeReward()">¬°Genial!</button>
        </div>
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    
    <!-- Canvas Confetti -->
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    
    <script src="js/version-check.js"></script>
    <script>
    (async function() {
        try {
            const versionCheck = await checkFilesVersion();
            if (versionCheck.needsUpdate) {
                if ('serviceWorker' in navigator) {
                    const registrations = await navigator.serviceWorker.getRegistrations();
                    for (let registration of registrations) {
                        await registration.unregister();
                    }
                    if ('caches' in window) {
                        const cacheNames = await caches.keys();
                        await Promise.all(cacheNames.map(name => caches.delete(name)));
                    }
                }
                saveStoredFileVersions(versionCheck.newVersions);
                window.location.reload(true);
                return; 
            }
            saveStoredFileVersions(versionCheck.newVersions);
        } catch (error) {
            console.error('Error en verificaci√≥n de versi√≥n:', error);
        }
    })();
    </script>
    
    <!-- Scripts del juego (solo se cargan si no hay actualizaci√≥n) -->
    <script src="js/modals.js"></script>
    <script src="js/data.js"></script>
    <script src="js/storage.js"></script>
    <script src="js/game.js"></script>
    
    <!-- Script de la p√°gina -->
    <script>
        let recompensaSeleccionada = null;
        
        function actualizarHeader() {
            const summary = window.game.getCharacterSummary();
            const purchased = window.storage.getPurchasedRewards();
            
            document.getElementById('headerNivel').textContent = summary.level;
            document.getElementById('headerOro').innerHTML = `${summary.gold} <i class="bi bi-coin text-warning"></i>`;
            document.getElementById('headerCompradas').textContent = purchased.length;
        }
        
        function crearTarjetaRecompensa(reward, state) {
            const colorClass = {
                'potion': 'border-purple',
                'peque√±a': 'border-success',
                'media': 'border-info',
                'grande': 'border-warning',
                'epica': 'border-danger'
            };
            
            const locked = !state.unlocked;
            const noGold = state.unlocked && !state.canPurchase;
            const hasCooldown = reward.cooldownHours && reward.cooldownHours > 0;
            let cooldownInfo = null;
            
            if (hasCooldown && !locked) {
                cooldownInfo = window.game.getRewardCooldownInfo(reward.id);
            }
            
            const onCooldown = cooldownInfo && cooldownInfo.onCooldown;
            
            let buttonHTML = '';
            let cooldownTimerHTML = '';
            
            if (locked) {
                buttonHTML = `
                    <button class="btn btn-secondary w-100" disabled>
                        <i class="bi bi-lock-fill"></i> Nivel ${reward.requiredLevel}
                    </button>
                `;
            } else if (onCooldown) {
                const hours = cooldownInfo.hoursRemaining;
                const minutes = cooldownInfo.minutesRemaining;
                const seconds = cooldownInfo.secondsRemaining;
                let timerText = '';
                if (hours > 0) {
                    timerText = `‚è±Ô∏è Disponible en: ${hours}h ${minutes}m`;
                } else if (minutes > 0) {
                    timerText = `‚è±Ô∏è Disponible en: ${minutes}m ${seconds}s`;
                } else {
                    timerText = `‚è±Ô∏è Disponible en: ${seconds}s`;
                }
                buttonHTML = `
                    <button class="btn btn-secondary w-100" disabled>
                        <i class="bi bi-clock"></i> En Cooldown
                    </button>
                `;
                cooldownTimerHTML = `
                    <small id="cooldown-timer-${reward.id}" class="d-block mt-2" style="color: #a0a0a0; text-align: center;">
                        ${timerText}
                    </small>
                `;
            } else if (noGold) {
                buttonHTML = `
                    <button class="btn btn-outline-warning w-100" disabled>
                        <i class="bi bi-coin"></i> No tienes oro suficiente
                    </button>
                `;
            } else {
                buttonHTML = `
                    <button class="btn btn-warning w-100" onclick="prepararCompra(${reward.id})">
                        <i class="bi bi-bag-check"></i> Comprar
                    </button>
                `;
            }
            
            const cardClass = locked ? 'recompensa-bloqueada' : '';
            
            return `
                <div class="col-md-6 col-lg-4 mb-3 recompensa-item" data-categoria="${reward.category}" data-reward-id="${reward.id}">
                    <div class="card h-100 recompensa-card ${colorClass[reward.category]} ${cardClass}">
                        <div class="card-body">
                            <div class="recompensa-icono mb-2">${reward.icon}</div>
                            <h6 class="card-title fw-bold">${reward.name}</h6>
                            <p class="card-text small" style="color: #a0a0a0;">${reward.description}</p>
                            
                            <div class="recompensa-precio mb-3">
                                <span class="badge bg-warning text-dark fs-6">
                                    <i class="bi bi-coin"></i> ${reward.price} Oro
                                </span>
                                ${locked ? `<span class="badge bg-secondary ms-2"><i class="bi bi-lock"></i> Nivel ${reward.requiredLevel}</span>` : ''}
                            </div>
                            
                            ${buttonHTML}
                            ${cooldownTimerHTML}
                        </div>
                    </div>
                </div>
            `;
        }
        
        function cargarRecompensas() {
            const rewardsWithState = window.game.getAvailableRewards();
            const allRewards = window.data.getAllRewards();
            
            const potions = rewardsWithState.filter(r => r.category === 'potion');
            const small = rewardsWithState.filter(r => r.category === 'peque√±a');
            const medium = rewardsWithState.filter(r => r.category === 'media');
            const large = rewardsWithState.filter(r => r.category === 'grande');
            const epic = rewardsWithState.filter(r => r.category === 'epica');
            
            document.getElementById('listaPociones').innerHTML = potions.map(r => 
                crearTarjetaRecompensa(allRewards.find(rec => rec.id === r.id), r)
            ).join('');
            
            document.getElementById('listaPequenas').innerHTML = small.map(r => 
                crearTarjetaRecompensa(allRewards.find(rec => rec.id === r.id), r)
            ).join('');
            
            document.getElementById('listaMedias').innerHTML = medium.map(r => 
                crearTarjetaRecompensa(allRewards.find(rec => rec.id === r.id), r)
            ).join('');
            
            document.getElementById('listaGrandes').innerHTML = large.map(r => 
                crearTarjetaRecompensa(allRewards.find(rec => rec.id === r.id), r)
            ).join('');
            
            document.getElementById('listaEpicas').innerHTML = epic.map(r => 
                crearTarjetaRecompensa(allRewards.find(rec => rec.id === r.id), r)
            ).join('');
        }
        
        function filtrarRecompensas(categoria) {
            const sections = document.querySelectorAll('.recompensas-seccion');
            const buttons = document.querySelectorAll('.btn-group .btn');
            
            buttons.forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');
            
            if (categoria === 'todas') {
                sections.forEach(s => s.style.display = 'block');
            } else {
                sections.forEach(s => s.style.display = 'none');
                if (categoria === 'potion') {
                    document.getElementById('recompensasPociones').style.display = 'block';
                } else if (categoria === 'peque√±a') {
                    document.getElementById('recompensasPequenas').style.display = 'block';
                } else if (categoria === 'media') {
                    document.getElementById('recompensasMedias').style.display = 'block';
                } else if (categoria === 'grande') {
                    document.getElementById('recompensasGrandes').style.display = 'block';
                } else if (categoria === 'epica') {
                    document.getElementById('recompensasEpicas').style.display = 'block';
                }
            }
        }
        
        function prepararCompra(rewardId) {
            const allRewards = window.data.getAllRewards();
            const reward = allRewards.find(r => r.id === rewardId);
            recompensaSeleccionada = reward;
            
            document.getElementById('modalRecompensaIcono').textContent = reward.icon;
            document.getElementById('modalRecompensaNombre').textContent = reward.name;
            document.getElementById('modalRecompensaDescripcion').textContent = reward.description;
            document.getElementById('modalRecompensaPrecio').textContent = reward.price;
            
            const modal = new bootstrap.Modal(document.getElementById('modalConfirmacion'));
            modal.show();
        }
        
        function confirmarCompra() {
            if (!recompensaSeleccionada) return;
            
            let result;
            if (recompensaSeleccionada.category === 'potion') {
                result = window.game.purchasePotion(recompensaSeleccionada.id);
            } else {
                result = window.game.purchaseReward(recompensaSeleccionada.id);
            }
            
            const modalConfirmacion = bootstrap.Modal.getInstance(document.getElementById('modalConfirmacion'));
            modalConfirmacion.hide();
            
            if (result.success) {
                setTimeout(() => {
                    const item = result.reward || result.potion;
                    mostrarExito(item);
                }, 300);
                
                cargarRecompensas();
                actualizarHeader();
            } else {
                showError(result.message);
            }
            
            recompensaSeleccionada = null;
        }
        
        function mostrarExito(reward) {
            const state = window.game.getState();
            
            document.getElementById('modalExitoIcono').textContent = reward.icon;
            document.getElementById('modalExitoNombre').textContent = reward.name;
            document.getElementById('modalExitoOroRestante').textContent = state.character.gold + ' oro';
            
            const modal = new bootstrap.Modal(document.getElementById('modalExito'));
            modal.show();
            
            confetti({
                particleCount: 150,
                spread: 80,
                origin: { y: 0.6 },
                colors: ['#FFD700', '#FFA500', '#FF6347']
            });
        }
        
        function updateRewardCooldowns() {
            const allRewards = window.data.getAllRewards();
            const rewardsWithCooldown = allRewards.filter(r => r.cooldownHours && r.cooldownHours > 0);
            let needsReload = false;
            
            rewardsWithCooldown.forEach(reward => {
                const timerElement = document.getElementById(`cooldown-timer-${reward.id}`);
                if (!timerElement) return;
                
                const cooldownInfo = window.game.getRewardCooldownInfo(reward.id);
                
                if (!cooldownInfo.onCooldown) {
                    if (timerElement.style.display !== 'none') {
                        needsReload = true;
                    }
                    return;
                }
                
                timerElement.style.display = 'block';
                const hours = cooldownInfo.hoursRemaining;
                const minutes = cooldownInfo.minutesRemaining;
                const seconds = cooldownInfo.secondsRemaining;
                
                let timerText = '';
                if (hours > 0) {
                    timerText = `‚è±Ô∏è Disponible en: ${hours}h ${minutes}m`;
                } else if (minutes > 0) {
                    timerText = `‚è±Ô∏è Disponible en: ${minutes}m ${seconds}s`;
                } else {
                    timerText = `‚è±Ô∏è Disponible en: ${seconds}s`;
                }
                
                timerElement.textContent = timerText;
            });
            
            if (needsReload) {
                cargarRecompensas();
            }
        }
        
        document.addEventListener('DOMContentLoaded', () => {
            if (!window.game.validateCharacterExists()) {
                return;
            }
            cargarRecompensas();
            actualizarHeader();
            
            setInterval(() => {
                updateRewardCooldowns();
            }, 1000);
        });
    </script>

    <!-- Registro del Service Worker para PWA -->
    <script>
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('./sw.js')
                    .then(registration => {
                        console.log('SW registrado:', registration.scope);
                    })
                    .catch(error => {
                        console.log('SW fallo:', error);
                    });
            });
        }
    </script>

    <!-- Bot√≥n Scroll to Top -->
    <button id="scrollToTop" class="scroll-to-top" title="Volver arriba">
        <i class="bi bi-arrow-up-circle-fill"></i>
    </button>

    <!-- PWA Install Button -->
    <script>
        let deferredPrompt;

        window.addEventListener('beforeinstallprompt', (e) => {
            e.preventDefault();
            deferredPrompt = e;
            document.getElementById('installPWA').style.display = 'block';
        });

        document.getElementById('installButton')?.addEventListener('click', async (e) => {
            e.preventDefault();
            
            if (!deferredPrompt) {
                return;
            }
            
            deferredPrompt.prompt();
            
            const { outcome } = await deferredPrompt.userChoice;
            
            if (outcome === 'accepted') {
                console.log('Usuario acept√≥ instalar PWA');
            }
            
            deferredPrompt = null;
            document.getElementById('installPWA').style.display = 'none';
        });

        window.addEventListener('appinstalled', () => {
            document.getElementById('installPWA').style.display = 'none';
            deferredPrompt = null;
        });
    </script>

    <!-- Bottom Navigation Bar - Solo m√≥vil -->
    <nav class="bottom-nav d-lg-none">
        <a href="tienda.html" class="bottom-nav-item active">
            <i class="bi bi-shop"></i>
            <span>Tienda</span>
        </a>
        <a href="misiones.html" class="bottom-nav-item">
            <i class="bi bi-list-check"></i>
            <span>Misiones</span>
        </a>
        <a href="index.html" class="bottom-nav-item center">
            <i class="bi bi-person-circle"></i>
            <span>Personaje</span>
        </a>
        <a href="#" class="bottom-nav-item" onclick="showWip(); return false;">
            <i class="bi bi-hourglass-split"></i>
            <span>WIP</span>
        </a>
        <a href="custom.html" class="bottom-nav-item">
            <i class="bi bi-gear"></i>
            <span>Personalizar</span>
        </a>
    </nav>

    <!-- Scroll to Top functionality -->
    <script>
        const scrollToTopBtn = document.getElementById('scrollToTop');
        
        window.addEventListener('scroll', () => {
            if (window.pageYOffset > 300) {
                scrollToTopBtn.classList.add('visible');
            } else {
                scrollToTopBtn.classList.remove('visible');
            }
        });
        
        scrollToTopBtn.addEventListener('click', () => {
            window.scrollTo({
                top: 0,
                behavior: 'smooth'
            });
        });
    </script>
</body>
</html>
